[
    {
        "id": "af4acfee68bc3611",
        "type": "function",
        "z": "39c6e012e231c2bd",
        "name": "Agregar",
        "func": "// ðŸ§© Lista de variÃ¡veis esperadas\nconst expectedVars = [\n    \"humi\", \"temp\", \"ai00\", \"ai01\",\n    \"psts\", \"vrms\", \"irms\", \"appp\", \"actp\", \"reap\"\n];\n\n// ðŸ”„ Recupera o JSON acumulado do contexto local (memÃ³ria)\nlet data = context.get(\"data\") || {};\n\n// ðŸŽ¯ DEBUG: Estado atual ANTES do processamento\nnode.warn(\"â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\");\nnode.warn(\"ðŸ”„ INICIANDO PROCESSAMENTO\");\nnode.warn(\"â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\");\n\n// DEBUG MAIS RESUMIDO para nÃ£o poluir\nlet receivedCount = Object.keys(data).length;\nlet missingCount = expectedVars.length - receivedCount;\nnode.warn(\"ðŸ“Š Progresso: \" + receivedCount + \"/\" + expectedVars.length + \" variÃ¡veis\");\n\n// ðŸ” Garante que o payload Ã© um array de objetos [{variable, value}]\nlet arr = msg.payload;\n\nif (typeof arr === \"string\") {\n    // Corrige mensagens com \"value\":SEM_ASPAS â†’ \"value\":\"SEM_ASPAS\"\n    arr = arr.replace(/\"value\":([A-Za-z_]+)/g, '\"value\":\"$1\"');\n    try {\n        arr = JSON.parse(arr);\n    } catch (e) {\n        node.error(\"âŒ ERRO no parse JSON: \" + e.message);\n        return null;\n    }\n}\n\n// Se for objeto Ãºnico, converte em array\nif (!Array.isArray(arr)) {\n    arr = [arr];\n}\n\n// ðŸ§  Atualiza o dicionÃ¡rio de variÃ¡veis recebidas\nif (arr.length > 0 && arr[0].variable) {\n    let item = arr[0];\n    \n    // DEBUG MAIS LIMPO - sÃ³ mostra variÃ¡vel sendo processada\n    node.warn(\"ðŸŽ¯ Processando: \" + item.variable + \" = \" + item.value);\n    \n    // Verifica se Ã© uma variÃ¡vel esperada\n    if (expectedVars.includes(item.variable)) {\n        data[item.variable] = item.value;\n    }\n}\n\n// ðŸ’¾ Salva novamente no contexto\ncontext.set(\"data\", data);\n\n// âš™ï¸ Verifica se todas as variÃ¡veis esperadas jÃ¡ chegaram\nlet allReceived = expectedVars.every(v => data.hasOwnProperty(v));\nlet missingVars = expectedVars.filter(v => !data.hasOwnProperty(v));\n\nif (allReceived) {\n    node.warn(\"ðŸš€ âœ… PACOTE COMPLETO ENVIADO!\");\n    node.warn(\"   ConteÃºdo: \" + JSON.stringify(data));\n    \n    msg.payload = data;\n    return msg;\n} else {\n    // Mostra progresso a cada 5 mensagens ou quando faltam poucas variÃ¡veis\n    let currentCount = Object.keys(data).length;\n    if (currentCount % 3 === 0 || missingVars.length <= 2) {\n        node.warn(\"â³ Aguardando: \" + missingVars.join(\", \"));\n    }\n}\n\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 540,
        "y": 260,
        "wires": [
            [
                "9a49991dbf1e6ed6",
                "mqtt_out_smart"
            ]
        ]
    }
]